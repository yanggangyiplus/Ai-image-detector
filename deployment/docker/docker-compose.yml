services:
  # FastAPI 백엔드 서버
  api:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.api
    container_name: ai-image-detector-api
    ports:
      - "8000:8000"
    volumes:
      # 체크포인트 마운트 (선택사항 - 이미지에 포함되어 있으면 불필요)
      - ../../experiments/checkpoints:/app/experiments/checkpoints:ro
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ai-detector-network

  # Streamlit 웹 데모
  streamlit:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.streamlit
    container_name: ai-image-detector-streamlit
    ports:
      - "8501:8501"
    volumes:
      - ../../experiments/checkpoints:/app/experiments/checkpoints:ro
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - ai-detector-network

networks:
  ai-detector-network:
    driver: bridge

# 사용 방법:
# docker-compose up -d          # 백그라운드 실행
# docker-compose up              # 포그라운드 실행
# docker-compose down            # 중지 및 제거
# docker-compose logs -f api     # API 로그 확인
# docker-compose logs -f streamlit  # Streamlit 로그 확인

